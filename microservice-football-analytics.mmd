flowchart TB
    %% Frontend Layer - Top Level
    subgraph Frontend["üñ•Ô∏è FRONTEND APPLICATIONS LAYER"]
        direction TB
        subgraph ShellApps["Shell Applications"]
            direction LR
            SAU["Shell App User<br/>·ª®ng d·ª•ng Shell Ng∆∞·ªùi d√πng"]
            SAA["Shell App Admin<br/>·ª®ng d·ª•ng Shell Qu·∫£n tr·ªã"]
        end
        
        subgraph MicroFrontends["Micro-Frontend Modules"]
            direction TB
            subgraph UserModules["User Modules"]
                direction LR
                PUM["Product User Module<br/>Module S·∫£n ph·∫©m Ng∆∞·ªùi d√πng"]
                CUM["Cart User Module<br/>Module Gi·ªè h√†ng Ng∆∞·ªùi d√πng"]
                NUM["News User Module<br/>Module Tin t·ª©c Ng∆∞·ªùi d√πng"]
            end
            subgraph AdminModules["Admin Modules"]
                direction LR
                PAM["Product Admin Module<br/>Module S·∫£n ph·∫©m Qu·∫£n tr·ªã"]
                NAM["News Admin Module<br/>Module Tin t·ª©c Qu·∫£n tr·ªã"]
            end
        end
    end
    
    %% BFF Layer - Middle Level
    subgraph BFFLayer["üîó BACKEND FOR FRONTEND (BFF) LAYER"]
        direction LR
        UBFF["User BFF<br/>Backend for Frontend Ng∆∞·ªùi d√πng"]
        ABFF["Admin BFF<br/>Backend for Frontend Qu·∫£n tr·ªã"]
    end
    
    %% Backend Services Layer - Lower Level
    subgraph BackendLayer["‚ö° BACKEND MICROSERVICES LAYER"]
        direction TB
        subgraph ConfigServices["Configuration Services"]
            direction LR
            SCS["Shell Config Service<br/>D·ªãch v·ª• C·∫•u h√¨nh Shell"]
        end
        
        subgraph CoreServices["Core Services"]
            direction LR
            AS["Admin Service<br/>D·ªãch v·ª• Qu·∫£n tr·ªã T·ªïng h·ª£p"]
            APS["Agent Policy Service<br/>D·ªãch v·ª• Ch√≠nh s√°ch ƒê·∫°i l√Ω"]
            AMS["Agent Management Service<br/>D·ªãch v·ª• Qu·∫£n l√Ω ƒê·∫°i l√Ω"]
        end
        
        subgraph BusinessServices["Business Services"]
            direction LR
            FS["Football Service<br/>D·ªãch v·ª• B√≥ng ƒë√°"]
            US["User Service<br/>D·ªãch v·ª• Ng∆∞·ªùi d√πng"]
            PS["Payment Service<br/>D·ªãch v·ª• Thanh to√°n"]
        end
        
        subgraph ExtendedServices["Extended Services"]
            direction LR
            CBS["Chatbot Service<br/>D·ªãch v·ª• Chatbot"]
            DCS["Design Calculation Service<br/>D·ªãch v·ª• T√≠nh to√°n Thi·∫øt k·∫ø"]
            FAS["Football Analytics Service<br/>D·ªãch v·ª• Ph√¢n t√≠ch B√≥ng ƒë√°"]
        end
        
        subgraph NewServices["New Services"]
            direction LR
            NS["News Service<br/>D·ªãch v·ª• Tin t·ª©c"]
            CTS["Cart Service<br/>D·ªãch v·ª• Gi·ªè h√†ng"]
            PRS["Product Service<br/>D·ªãch v·ª• S·∫£n ph·∫©m"]
        end
    end
    
    %% Infrastructure & Database Layer - Bottom Level
    subgraph InfraLayer["üóÑÔ∏è INFRASTRUCTURE & DATABASE LAYER"]
        direction TB
        subgraph Databases["Databases"]
            direction TB
            subgraph ConfigDB["Configuration Database"]
                direction LR
                SCDB[(Shell Config DB)]
            end
            subgraph DB1["Core Databases"]
                direction LR
                UDB[(User DB)]
                ADB[(Admin DB)]
                FDB[(Football DB)]
                APDB[(Agent Policy DB)]
            end
            subgraph DB2["Service Databases"]
                direction LR
                PDB[(Payment DB)]
                CBDB[(Chatbot DB)]
                DCDB[(Design Calculation DB)]
                FADB[(Football Analytics DB)]
            end
            subgraph DB3["New Service Databases"]
                direction LR
                AMDB[(Agent Management DB)]
                PRDB[(Product DB)]
                CTDB[(Cart DB)]
                NDB[(News DB)]
            end
        end
        
        subgraph Infrastructure["Infrastructure Components"]
            direction LR
            MB[Message Broker]
            CACHE[Cache]
        end
    end
    
    %% Vertical Layer Connections
    Frontend --> BFFLayer
    BFFLayer --> BackendLayer
    BackendLayer --> InfraLayer
    
    %% Shell App to Micro-Frontend connections
    SAU -.->|loads| PUM
    SAU -.->|loads| CUM
    SAU -.->|loads| NUM
    SAA -.->|loads| PAM
    SAA -.->|loads| NAM
    
    %% Shell Apps to BFF connections (ALL traffic goes through BFF)
    SAU --> UBFF
    SAA --> ABFF
    
    %% BFF to Shell Config Service connections (CORRECTED)
    UBFF --> SCS
    ABFF --> SCS
    
    %% User BFF to Backend Services connections
    UBFF --> US
    UBFF --> PRS
    UBFF --> CTS
    UBFF --> NS
    UBFF --> CBS
    UBFF --> PS
    UBFF --> FS
    UBFF --> DCS
    UBFF --> FAS
    
    %% Admin BFF to Backend Services connections
    ABFF --> AS
    ABFF --> APS
    ABFF --> AMS
    ABFF --> PRS
    ABFF --> NS
    ABFF --> US
    ABFF --> PS
    ABFF --> FS
    ABFF --> CBS
    ABFF --> DCS
    ABFF --> FAS
    
    %% Shell Config Service to Database
    SCS --> SCDB
    
    %% Services to Database connections
    US --> UDB
    AS --> ADB
    FS --> FDB
    APS --> APDB
    PS --> PDB
    CBS --> CBDB
    DCS --> DCDB
    FAS --> FADB
    AMS --> AMDB
    PRS --> PRDB
    CTS --> CTDB
    NS --> NDB
    
    %% Infrastructure connections
    AS --> MB
    US --> MB
    PS --> MB
    SCS --> CACHE
    AS --> CACHE
    US --> CACHE
    
    %% Styling
    classDef shellApp fill:#4a90e2,stroke:#2c5aa0,stroke-width:3px,color:#000000
    classDef microFrontend fill:#7ed321,stroke:#5cb85c,stroke-width:2px,color:#000000
    classDef shellConfig fill:#f5a623,stroke:#d68910,stroke-width:2px,color:#000000
    classDef bff fill:#bd10e0,stroke:#9013fe,stroke-width:3px,color:#000000
    classDef serviceGreen fill:#90ee90,stroke:#32cd32,stroke-width:2px,color:#000000
    classDef servicePink fill:#ffb6c1,stroke:#ff69b4,stroke-width:2px,color:#000000
    classDef database fill:#e6f3ff,stroke:#87ceeb,stroke-width:2px,color:#000000
    classDef infrastructure fill:#ffe4e1,stroke:#ffa07a,stroke-width:2px,color:#000000
    classDef layerStyle fill:#f9f9f9,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5,color:#000000
    
    %% Apply classes
    class SAU,SAA shellApp
    class PUM,CUM,NUM,PAM,NAM microFrontend
    class SCS shellConfig
    class SCDB shellConfig
    class UBFF,ABFF bff
    class AS,APS,AMS,FS,US,PS,CBS,DCS,FAS serviceGreen
    class NS,CTS,PRS servicePink
    class UDB,ADB,FDB,APDB,PDB,CBDB,DCDB,FADB,AMDB,PRDB,CTDB,NDB,SCDB database
    class MB,CACHE infrastructure
    class Frontend,BFFLayer,BackendLayer,InfraLayer layerStyle