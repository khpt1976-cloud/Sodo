flowchart TB
    %% Frontend Layer - Top Level
    subgraph Frontend["üñ•Ô∏è FRONTEND APPLICATIONS LAYER"]
        direction TB
        subgraph ShellApps["Shell Applications"]
            direction LR
            SAU["Shell App User<br/>·ª®ng d·ª•ng Shell Ng∆∞·ªùi d√πng"]
            SAA["Shell App Admin<br/>·ª®ng d·ª•ng Shell Qu·∫£n tr·ªã"]
        end
        
        subgraph MicroFrontends["Micro-Frontend Modules"]
            direction TB
            subgraph UserModules["User Modules"]
                direction TB
                subgraph CoreUserModules["Core User Modules"]
                    direction LR
                    UPM["User Profile Module<br/>Module H·ªì s∆° Ng∆∞·ªùi d√πng"]
                    FUM["Football User Module<br/>Module B√≥ng ƒë√° Ng∆∞·ªùi d√πng"]
                    PUM["Product User Module<br/>Module S·∫£n ph·∫©m Ng∆∞·ªùi d√πng"]
                end
                subgraph BusinessUserModules["Business User Modules"]
                    direction LR
                    CUM["Cart User Module<br/>Module Gi·ªè h√†ng Ng∆∞·ªùi d√πng"]
                    PAM_USER["Payment User Module<br/>Module Thanh to√°n Ng∆∞·ªùi d√πng"]
                    CBM["Chatbot User Module<br/>Module Chatbot Ng∆∞·ªùi d√πng"]
                end
                subgraph ServiceUserModules["Service User Modules"]
                    direction LR
                    NUM["News User Module<br/>Module Tin t·ª©c Ng∆∞·ªùi d√πng"]
                    CLUM["Construction Log User Module<br/>Module Nh·∫≠t k√Ω Thi c√¥ng Ng∆∞·ªùi d√πng"]
                    DCUM["Design Calculation User Module<br/>Module T√≠nh to√°n Thi·∫øt k·∫ø Ng∆∞·ªùi d√πng"]
                end
                subgraph AgentUserModules["Agent User Modules"]
                    direction LR
                    AUM["Agent User Module<br/>Module ƒê·∫°i l√Ω Ng∆∞·ªùi d√πng"]
                    APUM["Agent Policy User Module<br/>Module Ch√≠nh s√°ch ƒê·∫°i l√Ω Ng∆∞·ªùi d√πng"]
                end
            end
            subgraph AdminModules["Admin Modules"]
                direction TB
                subgraph CoreAdminModules["Core Admin Modules"]
                    direction LR
                    UAM["User Admin Module<br/>Module Qu·∫£n tr·ªã Ng∆∞·ªùi d√πng"]
                    FAM["Football Admin Module<br/>Module Qu·∫£n tr·ªã B√≥ng ƒë√°"]
                    PAM["Product Admin Module<br/>Module S·∫£n ph·∫©m Qu·∫£n tr·ªã"]
                end
                subgraph BusinessAdminModules["Business Admin Modules"]
                    direction LR
                    PAYAM["Payment Admin Module<br/>Module Qu·∫£n tr·ªã Thanh to√°n"]
                    CBAM["Chatbot Admin Module<br/>Module Qu·∫£n tr·ªã Chatbot"]
                    NAM["News Admin Module<br/>Module Tin t·ª©c Qu·∫£n tr·ªã"]
                end
                subgraph ServiceAdminModules["Service Admin Modules"]
                    direction LR
                    CLAM["Construction Log Admin Module<br/>Module Qu·∫£n tr·ªã Nh·∫≠t k√Ω Thi c√¥ng"]
                    DCAM["Design Calculation Admin Module<br/>Module Qu·∫£n tr·ªã T√≠nh to√°n Thi·∫øt k·∫ø"]
                    SAM["System Admin Module<br/>Module Qu·∫£n tr·ªã H·ªá th·ªëng"]
                end
                subgraph AgentAdminModules["Agent Admin Modules"]
                    direction LR
                    AMAM["Agent Management Admin Module<br/>Module Qu·∫£n tr·ªã ƒê·∫°i l√Ω"]
                    APAM["Agent Policy Admin Module<br/>Module Qu·∫£n tr·ªã Ch√≠nh s√°ch ƒê·∫°i l√Ω"]
                end
            end
        end
    end
    
    %% BFF Layer - Middle Level
    subgraph BFFLayer["üîó BACKEND FOR FRONTEND (BFF) LAYER"]
        direction LR
        UBFF["User BFF<br/>Backend for Frontend Ng∆∞·ªùi d√πng"]
        ABFF["Admin BFF<br/>Backend for Frontend Qu·∫£n tr·ªã"]
    end
    
    %% Backend Services Layer - Lower Level
    subgraph BackendLayer["‚ö° BACKEND MICROSERVICES LAYER"]
        direction TB
        subgraph ConfigServices["Configuration Services"]
            direction LR
            SCS["Shell Config Service<br/>D·ªãch v·ª• C·∫•u h√¨nh Shell"]
        end
        
        subgraph CoreServices["Core Services"]
            direction LR
            APS["Agent Policy Service<br/>D·ªãch v·ª• Ch√≠nh s√°ch ƒê·∫°i l√Ω"]
            AMS["Agent Management Service<br/>D·ªãch v·ª• Qu·∫£n l√Ω ƒê·∫°i l√Ω"]
        end
        
        subgraph BusinessServices["Business Services"]
            direction LR
            FS["Football Service<br/>D·ªãch v·ª• B√≥ng ƒë√°"]
            US["User Service<br/>D·ªãch v·ª• Ng∆∞·ªùi d√πng"]
            PS["Payment Service<br/>D·ªãch v·ª• Thanh to√°n"]
        end
        
        subgraph ExtendedServices["Extended Services"]
            direction LR
            CBS["Chatbot Service<br/>D·ªãch v·ª• Chatbot"]
            DCS["Design Calculation Service<br/>D·ªãch v·ª• T√≠nh to√°n Thi·∫øt k·∫ø"]
            FAS["Construction Log Service<br/>D·ªãch v·ª• Nh·∫≠t k√Ω Thi c√¥ng"]
        end
        
        subgraph NewServices["New Services"]
            direction LR
            NS["News Service<br/>D·ªãch v·ª• Tin t·ª©c"]
            CTS["Cart Service<br/>D·ªãch v·ª• Gi·ªè h√†ng"]
            PRS["Product Service<br/>D·ªãch v·ª• S·∫£n ph·∫©m"]
        end
    end
    
    %% Infrastructure & Database Layer - Bottom Level
    subgraph InfraLayer["üóÑÔ∏è INFRASTRUCTURE & DATABASE LAYER"]
        direction TB
        subgraph Databases["Databases"]
            direction TB
            subgraph ConfigDB["Configuration Database"]
                direction LR
                SCDB[(Shell Config DB)]
            end
            subgraph DB1["Core Databases"]
                direction LR
                UDB[(User DB)]
                FDB[(Football DB)]
                APDB[(Agent Policy DB)]
            end
            subgraph DB2["Service Databases"]
                direction LR
                PDB[(Payment DB)]
                CBDB[(Chatbot DB)]
                DCDB[(Design Calculation DB)]
                FADB[(Construction Log DB)]
            end
            subgraph DB3["New Service Databases"]
                direction LR
                AMDB[(Agent Management DB)]
                PRDB[(Product DB)]
                CTDB[(Cart DB)]
                NDB[(News DB)]
            end
        end
        
        subgraph Infrastructure["Infrastructure Components"]
            direction LR
            MB[Message Broker]
            CACHE[Cache]
        end
    end
    
    %% Vertical Layer Connections
    Frontend --> BFFLayer
    BFFLayer --> BackendLayer
    BackendLayer --> InfraLayer
    
    %% Shell App User to User Modules connections
    SAU -.->|loads| UPM
    SAU -.->|loads| FUM
    SAU -.->|loads| PUM
    SAU -.->|loads| CUM
    SAU -.->|loads| PAM_USER
    SAU -.->|loads| CBM
    SAU -.->|loads| NUM
    SAU -.->|loads| CLUM
    SAU -.->|loads| DCUM
    SAU -.->|loads| AUM
    SAU -.->|loads| APUM
    
    %% Shell App Admin to Admin Modules connections
    SAA -.->|loads| UAM
    SAA -.->|loads| FAM
    SAA -.->|loads| PAM
    SAA -.->|loads| PAYAM
    SAA -.->|loads| CBAM
    SAA -.->|loads| NAM
    SAA -.->|loads| CLAM
    SAA -.->|loads| DCAM
    SAA -.->|loads| SAM
    SAA -.->|loads| AMAM
    SAA -.->|loads| APAM
    
    %% Shell Apps to BFF connections (ALL traffic goes through BFF)
    SAU --> UBFF
    SAA --> ABFF
    
    %% BFF to Shell Config Service connections (CORRECTED)
    UBFF --> SCS
    ABFF --> SCS
    
    %% User BFF to Backend Services connections
    UBFF --> US
    UBFF --> PRS
    UBFF --> CTS
    UBFF --> NS
    UBFF --> CBS
    UBFF --> PS
    UBFF --> FS
    UBFF --> DCS
    UBFF --> FAS
    
    %% Admin BFF to Backend Services connections
    ABFF --> APS
    ABFF --> AMS
    ABFF --> PRS
    ABFF --> NS
    ABFF --> US
    ABFF --> PS
    ABFF --> FS
    ABFF --> CBS
    ABFF --> DCS
    ABFF --> FAS
    
    %% Shell Config Service to Database
    SCS --> SCDB
    
    %% Services to Database connections
    US --> UDB
    FS --> FDB
    APS --> APDB
    PS --> PDB
    CBS --> CBDB
    DCS --> DCDB
    FAS --> FADB
    AMS --> AMDB
    PRS --> PRDB
    CTS --> CTDB
    NS --> NDB
    
    %% Infrastructure connections
    US --> MB
    PS --> MB
    SCS --> CACHE
    US --> CACHE
    
    %% Styling
    classDef shellApp fill:#4a90e2,stroke:#2c5aa0,stroke-width:3px,color:#000000
    classDef microFrontend fill:#7ed321,stroke:#5cb85c,stroke-width:2px,color:#000000
    classDef shellConfig fill:#f5a623,stroke:#d68910,stroke-width:2px,color:#000000
    classDef bff fill:#bd10e0,stroke:#9013fe,stroke-width:3px,color:#000000
    classDef serviceGreen fill:#90ee90,stroke:#32cd32,stroke-width:2px,color:#000000
    classDef servicePink fill:#ffb6c1,stroke:#ff69b4,stroke-width:2px,color:#000000
    classDef database fill:#e6f3ff,stroke:#87ceeb,stroke-width:2px,color:#000000
    classDef infrastructure fill:#ffe4e1,stroke:#ffa07a,stroke-width:2px,color:#000000
    classDef layerStyle fill:#f9f9f9,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5,color:#000000
    
    %% Apply classes
    class SAU,SAA shellApp
    class UPM,FUM,PUM,CUM,PAM_USER,CBM,NUM,CLUM,DCUM,AUM,APUM microFrontend
    class UAM,FAM,PAM,PAYAM,CBAM,NAM,CLAM,DCAM,SAM,AMAM,APAM microFrontend
    class SCS shellConfig
    class SCDB shellConfig
    class UBFF,ABFF bff
    class APS,AMS,FS,US,PS,CBS,DCS,FAS serviceGreen
    class NS,CTS,PRS servicePink
    class UDB,FDB,APDB,PDB,CBDB,DCDB,FADB,AMDB,PRDB,CTDB,NDB,SCDB database
    class MB,CACHE infrastructure
    class Frontend,BFFLayer,BackendLayer,InfraLayer layerStyle