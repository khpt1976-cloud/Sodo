<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S∆° ƒë·ªì Ki·∫øn tr√∫c BFF - Ch·ªØ ƒêen ƒê·∫≠m</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .subtitle {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .zoom-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
        }
        
        .zoom-btn:hover {
            background: #0056b3;
        }
        
        .zoom-info {
            text-align: center;
            font-size: 14px;
            color: #333;
            margin: 5px 0;
            font-weight: bold;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
        }
        
        /* Diagram Container */
        .diagram-container {
            position: relative;
            width: 100%;
            height: 800px;
            overflow: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #fffef0;
            cursor: grab;
            user-select: none;
        }
        
        .diagram-container.panning {
            cursor: grabbing;
        }
        
        .mermaid-wrapper {
            transform-origin: 0 0;
            transition: transform 0.3s ease;
            min-width: 100%;
            min-height: 100%;
        }
        
        .mermaid {
            width: 100%;
            height: 100%;
            padding: 30px;
        }
        
        /* FORCE ALL TEXT TO BE BLACK AND BOLD */
        .mermaid * {
            color: #000000 !important;
            fill: #000000 !important;
            font-weight: bold !important;
            font-family: Arial, sans-serif !important;
        }
        
        .mermaid text {
            fill: #000000 !important;
            font-weight: bold !important;
            font-family: Arial, sans-serif !important;
            font-size: 14px !important;
        }
        
        .mermaid .nodeLabel,
        .mermaid .edgeLabel,
        .mermaid .cluster-label text,
        .mermaid .titleText,
        .mermaid .node text,
        .mermaid .label {
            color: #000000 !important;
            fill: #000000 !important;
            font-weight: bold !important;
            font-family: Arial, sans-serif !important;
        }
        
        /* Controls Info */
        .controls-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 280px;
            z-index: 1000;
        }
        
        .controls-info h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #ffd700;
        }
        
        .controls-info p {
            margin: 5px 0;
        }
        
        .controls-info .highlight {
            color: #ffd700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">S∆° ƒë·ªì Ki·∫øn tr√∫c Micro-Frontend & BFF</div>
        <div class="subtitle">T·∫•t c·∫£ ch·ªØ m√†u ƒëen ƒë·∫≠m - C√≥ th·ªÉ Zoom & Pan</div>
        
        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">üîç Zoom In (+)</button>
            <div class="zoom-info" id="zoom-level">100%</div>
            <button class="zoom-btn" onclick="zoomOut()">üîç Zoom Out (-)</button>
            <button class="zoom-btn" onclick="resetZoom()">‚Üª Reset</button>
            <button class="zoom-btn" onclick="fitToScreen()">üìê Fit Screen</button>
        </div>
        
        <div class="diagram-container" id="diagram-container">
            <div class="mermaid-wrapper" id="mermaid-wrapper">
                <div class="mermaid" id="mermaid-diagram">
                    flowchart TB
                        %% Frontend Layer - Top Level
                        subgraph Frontend["üñ•Ô∏è FRONTEND APPLICATIONS LAYER"]
                            direction TB
                            subgraph ShellApps["Shell Applications"]
                                direction LR
                                SAU["Shell App User<br/>·ª®ng d·ª•ng Shell Ng∆∞·ªùi d√πng"]
                                SAA["Shell App Admin<br/>·ª®ng d·ª•ng Shell Qu·∫£n tr·ªã"]
                            end
                            
                            subgraph MicroFrontends["Micro-Frontend Modules"]
                                direction TB
                                subgraph UserModules["User Modules"]
                                    direction LR
                                    PUM["Product User Module<br/>Module S·∫£n ph·∫©m Ng∆∞·ªùi d√πng"]
                                    CUM["Cart User Module<br/>Module Gi·ªè h√†ng Ng∆∞·ªùi d√πng"]
                                    NUM["News User Module<br/>Module Tin t·ª©c Ng∆∞·ªùi d√πng"]
                                end
                                subgraph AdminModules["Admin Modules"]
                                    direction LR
                                    PAM["Product Admin Module<br/>Module S·∫£n ph·∫©m Qu·∫£n tr·ªã"]
                                    NAM["News Admin Module<br/>Module Tin t·ª©c Qu·∫£n tr·ªã"]
                                end
                            end
                        end
                        
                        %% BFF Layer - Middle Level
                        subgraph BFFLayer["üîó BACKEND FOR FRONTEND (BFF) LAYER"]
                            direction LR
                            UBFF["User BFF<br/>Backend for Frontend Ng∆∞·ªùi d√πng"]
                            ABFF["Admin BFF<br/>Backend for Frontend Qu·∫£n tr·ªã"]
                        end
                        
                        %% Backend Services Layer - Lower Level
                        subgraph BackendLayer["‚ö° BACKEND MICROSERVICES LAYER"]
                            direction TB
                            subgraph ConfigServices["Configuration Services"]
                                direction LR
                                SCS["Shell Config Service<br/>D·ªãch v·ª• C·∫•u h√¨nh Shell"]
                            end
                            
                            subgraph CoreServices["Core Services"]
                                direction LR
                                AS["Admin Service<br/>D·ªãch v·ª• Qu·∫£n tr·ªã T·ªïng h·ª£p"]
                                APS["Agent Policy Service<br/>D·ªãch v·ª• Ch√≠nh s√°ch ƒê·∫°i l√Ω"]
                                AMS["Agent Management Service<br/>D·ªãch v·ª• Qu·∫£n l√Ω ƒê·∫°i l√Ω"]
                            end
                            
                            subgraph BusinessServices["Business Services"]
                                direction LR
                                FS["Football Service<br/>D·ªãch v·ª• B√≥ng ƒë√°"]
                                US["User Service<br/>D·ªãch v·ª• Ng∆∞·ªùi d√πng"]
                                PS["Payment Service<br/>D·ªãch v·ª• Thanh to√°n"]
                            end
                            
                            subgraph ExtendedServices["Extended Services"]
                                direction LR
                                CBS["Chatbot Service<br/>D·ªãch v·ª• Chatbot"]
                                DCS["Design Calculation Service<br/>D·ªãch v·ª• T√≠nh to√°n Thi·∫øt k·∫ø"]
                                FAS["Construction Log Service<br/>D·ªãch v·ª• Nh·∫≠t k√Ω Thi c√¥ng"]
                            end
                            
                            subgraph NewServices["New Services"]
                                direction LR
                                NS["News Service<br/>D·ªãch v·ª• Tin t·ª©c"]
                                CTS["Cart Service<br/>D·ªãch v·ª• Gi·ªè h√†ng"]
                                PRS["Product Service<br/>D·ªãch v·ª• S·∫£n ph·∫©m"]
                            end
                        end
                        
                        %% Infrastructure & Database Layer - Bottom Level
                        subgraph InfraLayer["üóÑÔ∏è INFRASTRUCTURE & DATABASE LAYER"]
                            direction TB
                            subgraph Databases["Databases"]
                                direction TB
                                subgraph ConfigDB["Configuration Database"]
                                    direction LR
                                    SCDB[(Shell Config DB)]
                                end
                                subgraph DB1["Core Databases"]
                                    direction LR
                                    UDB[(User DB)]
                                    ADB[(Admin DB)]
                                    FDB[(Football DB)]
                                    APDB[(Agent Policy DB)]
                                end
                                subgraph DB2["Service Databases"]
                                    direction LR
                                    PDB[(Payment DB)]
                                    CBDB[(Chatbot DB)]
                                    DCDB[(Design Calculation DB)]
                                    FADB[(Construction Log DB)]
                                end
                                subgraph DB3["New Service Databases"]
                                    direction LR
                                    AMDB[(Agent Management DB)]
                                    PRDB[(Product DB)]
                                    CTDB[(Cart DB)]
                                    NDB[(News DB)]
                                end
                            end
                            
                            subgraph Infrastructure["Infrastructure Components"]
                                direction LR
                                MB[Message Broker]
                                CACHE[Cache]
                            end
                        end
                        
                        %% Vertical Layer Connections
                        Frontend --> BFFLayer
                        BFFLayer --> BackendLayer
                        BackendLayer --> InfraLayer
                        
                        %% Shell App to Micro-Frontend connections
                        SAU -.->|loads| PUM
                        SAU -.->|loads| CUM
                        SAU -.->|loads| NUM
                        SAA -.->|loads| PAM
                        SAA -.->|loads| NAM
                        
                        %% Shell Apps to BFF connections (ALL traffic goes through BFF)
                        SAU --> UBFF
                        SAA --> ABFF
                        
                        %% BFF to Shell Config Service connections (CORRECTED)
                        UBFF --> SCS
                        ABFF --> SCS
                        
                        %% User BFF to Backend Services connections
                        UBFF --> US
                        UBFF --> PRS
                        UBFF --> CTS
                        UBFF --> NS
                        UBFF --> CBS
                        UBFF --> PS
                        UBFF --> FS
                        UBFF --> DCS
                        UBFF --> FAS
                        
                        %% Admin BFF to Backend Services connections
                        ABFF --> AS
                        ABFF --> APS
                        ABFF --> AMS
                        ABFF --> PRS
                        ABFF --> NS
                        ABFF --> US
                        ABFF --> PS
                        ABFF --> FS
                        ABFF --> CBS
                        ABFF --> DCS
                        ABFF --> FAS
                        
                        %% Shell Config Service to Database
                        SCS --> SCDB
                        
                        %% Services to Database connections
                        US --> UDB
                        AS --> ADB
                        FS --> FDB
                        APS --> APDB
                        PS --> PDB
                        CBS --> CBDB
                        DCS --> DCDB
                        FAS --> FADB
                        AMS --> AMDB
                        PRS --> PRDB
                        CTS --> CTDB
                        NS --> NDB
                        
                        %% Infrastructure connections
                        AS --> MB
                        US --> MB
                        PS --> MB
                        SCS --> CACHE
                        AS --> CACHE
                        US --> CACHE
                        
                        %% Styling
                        classDef shellApp fill:#4a90e2,stroke:#2c5aa0,stroke-width:3px,color:#000000
                        classDef microFrontend fill:#7ed321,stroke:#5cb85c,stroke-width:2px,color:#000000
                        classDef shellConfig fill:#f5a623,stroke:#d68910,stroke-width:2px,color:#000000
                        classDef bff fill:#bd10e0,stroke:#9013fe,stroke-width:3px,color:#000000
                        classDef serviceGreen fill:#90ee90,stroke:#32cd32,stroke-width:2px,color:#000000
                        classDef servicePink fill:#ffb6c1,stroke:#ff69b4,stroke-width:2px,color:#000000
                        classDef database fill:#e6f3ff,stroke:#87ceeb,stroke-width:2px,color:#000000
                        classDef infrastructure fill:#ffe4e1,stroke:#ffa07a,stroke-width:2px,color:#000000
                        classDef layerStyle fill:#f9f9f9,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5,color:#000000
                        
                        %% Apply classes
                        class SAU,SAA shellApp
                        class PUM,CUM,NUM,PAM,NAM microFrontend
                        class SCS shellConfig
                        class SCDB shellConfig
                        class UBFF,ABFF bff
                        class AS,APS,AMS,FS,US,PS,CBS,DCS,FAS serviceGreen
                        class NS,CTS,PRS servicePink
                        class UDB,ADB,FDB,APDB,PDB,CBDB,DCDB,FADB,AMDB,PRDB,CTDB,NDB,SCDB database
                        class MB,CACHE infrastructure
                        class Frontend,BFFLayer,BackendLayer,InfraLayer layerStyle
                </div>
            </div>
        </div>
    </div>

    <!-- Controls Info -->
    <div class="controls-info">
        <h4>üéÆ ƒêi·ªÅu khi·ªÉn s∆° ƒë·ªì</h4>
        <p><span class="highlight">Chu·ªôt tr√°i + K√©o:</span> Di chuy·ªÉn s∆° ƒë·ªì üëÜ</p>
        <p><span class="highlight">Con lƒÉn chu·ªôt:</span> Zoom In/Out</p>
        <p><span class="highlight">+ ho·∫∑c =:</span> Zoom In</p>
        <p><span class="highlight">-:</span> Zoom Out</p>
        <p><span class="highlight">0:</span> Reset Zoom</p>
        <p><span class="highlight">F:</span> Fit to Screen</p>
    </div>

    <script>
        let currentZoom = 1;
        const zoomStep = 0.2;
        const minZoom = 0.3;
        const maxZoom = 3;
        
        const wrapper = document.getElementById('mermaid-wrapper');
        const container = document.getElementById('diagram-container');
        const zoomLevelDisplay = document.getElementById('zoom-level');
        
        // Initialize Mermaid with black text theme
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                curve: 'basis',
                padding: 20,
                nodeSpacing: 60,
                rankSpacing: 100,
                htmlLabels: true,
                useMaxWidth: false
            },
            themeVariables: {
                fontFamily: 'Arial, sans-serif',
                fontSize: '14px',
                primaryTextColor: '#000000',
                primaryColor: '#ffffff',
                primaryBorderColor: '#000000',
                lineColor: '#000000',
                secondaryColor: '#ffffff',
                tertiaryColor: '#ffffff',
                background: '#ffffff',
                mainBkg: '#ffffff',
                secondBkg: '#ffffff',
                tertiaryBkg: '#ffffff',
                edgeLabelBackground: '#ffffff',
                clusterBkg: 'none',
                altBackground: '#ffffff',
                nodeTextColor: '#000000'
            }
        });
        
        function updateZoom() {
            wrapper.style.transform = `scale(${currentZoom})`;
            zoomLevelDisplay.textContent = Math.round(currentZoom * 100) + '%';
        }
        
        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                updateZoom();
            }
        }
        
        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                updateZoom();
            }
        }
        
        function resetZoom() {
            currentZoom = 1;
            updateZoom();
        }
        
        function fitToScreen() {
            const containerRect = container.getBoundingClientRect();
            const wrapperRect = wrapper.getBoundingClientRect();
            
            const scaleX = containerRect.width / wrapperRect.width;
            const scaleY = containerRect.height / wrapperRect.height;
            
            currentZoom = Math.min(scaleX, scaleY, 1);
            updateZoom();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                    e.preventDefault();
                    zoomOut();
                    break;
                case '0':
                    e.preventDefault();
                    resetZoom();
                    break;
                case 'f':
                case 'F':
                    e.preventDefault();
                    fitToScreen();
                    break;
            }
        });
        
        // Mouse wheel zoom
        container.addEventListener('wheel', function(e) {
            e.preventDefault();
            
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });
        
        // Pan functionality - Left mouse button drag
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;
        
        container.addEventListener('mousedown', function(e) {
            if (e.button === 0) {
                isPanning = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
                container.classList.add('panning');
                e.preventDefault();
            }
        });
        
        document.addEventListener('mouseup', function() {
            isPanning = false;
            container.classList.remove('panning');
        });
        
        document.addEventListener('mouseleave', function() {
            isPanning = false;
            container.classList.remove('panning');
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isPanning) return;
            e.preventDefault();
            
            const x = e.pageX - container.offsetLeft;
            const y = e.pageY - container.offsetTop;
            const walkX = (x - startX) * 1.5;
            const walkY = (y - startY) * 1.5;
            
            container.scrollLeft = scrollLeft - walkX;
            container.scrollTop = scrollTop - walkY;
        });
        
        // Prevent text selection while dragging
        container.addEventListener('selectstart', function(e) {
            if (isPanning) {
                e.preventDefault();
            }
        });
        
        // Initialize zoom display
        updateZoom();
        
        // Force black text and fix background issues after Mermaid renders
        setTimeout(function() {
            const allTexts = document.querySelectorAll('.mermaid text, .mermaid .nodeLabel, .mermaid .edgeLabel');
            allTexts.forEach(function(text) {
                text.style.fill = '#000000';
                text.style.color = '#000000';
                text.style.fontWeight = 'bold';
                text.style.fontFamily = 'Arial, sans-serif';
            });
            
            // Fix cluster backgrounds that might be causing black areas
            const clusters = document.querySelectorAll('.mermaid .cluster rect');
            clusters.forEach(function(cluster) {
                cluster.style.fill = 'none';
                cluster.style.fillOpacity = '0';
                cluster.style.stroke = '#666';
                cluster.style.strokeWidth = '1px';
                cluster.style.strokeDasharray = '5,5';
            });
            
            // Fix any problematic backgrounds
            const backgrounds = document.querySelectorAll('.mermaid rect[fill="#000000"], .mermaid rect[fill="black"]');
            backgrounds.forEach(function(bg) {
                bg.style.fill = 'none';
                bg.style.fillOpacity = '0';
            });
            
            // Ensure subgraph backgrounds are transparent
            const subgraphs = document.querySelectorAll('.mermaid .subgraph rect');
            subgraphs.forEach(function(sg) {
                sg.style.fill = 'none';
                sg.style.fillOpacity = '0';
            });
        }, 3000);
        
        // Additional check after longer delay
        setTimeout(function() {
            const mermaidDiv = document.querySelector('.mermaid');
            if (mermaidDiv && mermaidDiv.innerHTML.trim() === '') {
                console.log('Mermaid failed to render, trying to re-render...');
                mermaid.init();
            }
        }, 5000);
    </script>
</body>
</html>